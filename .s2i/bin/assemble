#!/bin/bash

# Script de ensamblaje personalizado para S2I
# Este script se ejecuta durante el build para compilar y copiar los artefactos correctamente

set -e

echo "ðŸ”¨ Iniciando proceso de ensamblaje personalizado..."

# Ejecutar el script de ensamblaje base de la imagen
echo "ðŸ“¦ Ejecutando ensamblaje base..."
/usr/local/s2i/assemble

echo "ðŸ—ï¸  Verificando estructura despuÃ©s del build base..."
ls -la /tmp/src/
ls -la /tmp/src/target/ 2>/dev/null || echo "Directorio target no encontrado"

# Verificar que el build de Maven fue exitoso
if [ ! -d "/tmp/src/target" ]; then
    echo "âŒ Error: No se encontrÃ³ directorio target"
    exit 1
fi

if [ ! -d "/tmp/src/target/quarkus-app" ]; then
    echo "âŒ Error: No se encontrÃ³ directorio quarkus-app"
    echo "Contenido de target/:"
    ls -la /tmp/src/target/
    exit 1
fi

echo "âœ… Build de Maven exitoso, copiando artefactos..."

# Limpiar directorio de deployments
rm -rf /deployments/*

# Copiar artefactos de Quarkus al directorio de deployments
echo "ðŸ“‹ Copiando lib/..."
cp -r /tmp/src/target/quarkus-app/lib /deployments/

echo "ðŸ“‹ Copiando quarkus/..."
cp -r /tmp/src/target/quarkus-app/quarkus /deployments/

echo "ðŸ“‹ Copiando app/..."
cp -r /tmp/src/target/quarkus-app/app /deployments/

echo "ðŸ“‹ Copiando JARs principales..."
cp /tmp/src/target/quarkus-app/*.jar /deployments/

# Configurar variable JAVA_APP_JAR para que apunte al JAR correcto
echo "âš™ï¸  Configurando JAVA_APP_JAR..."
echo "JAVA_APP_JAR=/deployments/quarkus-run.jar" > /deployments/.s2i_env

# Ajustar permisos
echo "ðŸ”’ Ajustando permisos..."
chown -R 185:0 /deployments
chmod -R g+rw /deployments

echo "ðŸ“Š Verificando resultado final..."
ls -la /deployments/
echo ""
echo "ðŸ“‹ Archivos JAR encontrados:"
find /deployments -name "*.jar" -type f

echo "âœ… Ensamblaje completado exitosamente"